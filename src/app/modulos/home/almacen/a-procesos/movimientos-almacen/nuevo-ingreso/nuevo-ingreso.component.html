<ngx-spinner bdColor="rgba(0,0,0,0.8)" size="meidum" [zIndex]="999"  color="#fff" type="timer" [fullScreen]="true">
    <p style="font-size: 20px; color: white">CARGANDO. </p>
</ngx-spinner>

<div *ngIf="!VistaReporte"> 
    <div class="margintabla-home">
        <div class="card-box"> 
   
            <p-toolbar>
                <div class="p-toolbar-group-left">
                    <h3> <i class="fas fa-dolly-flatbed"></i>  {{ tituloNuevoMovimiento }} </h3>  
                </div>
                <div class="p-toolbar-group-right">
                    <button 
                        *ngIf="mostrarBotonReportes"
                        pButton  
                        type="button"
                        label="Reporte" 
                        class="p-button-generico-azul"
                        (click)="onReporte()" 
                        icon="pi pi-file">
                    </button>   
                    <button  
                        class="p-button-registrar"
                        pButton
                        type="button"
                        [disabled]="Form.invalid" 
                        label="Guardar"
                        (click)="onGrabar()"
                        icon="pi pi-check-circle">  
                    </button>  
                    <button   
                        class="p-button-cancelar"
                        pButton
                        type="button"
                        icon="pi pi-times-circle"
                        label="Cancelar" 
                        (click)="onRegresar()">  
                    </button>      
                </div>
            </p-toolbar>

            <div *ngIf="existenroRegsitro"  class="centrar">   
                <h3> N° REGISTRO:  <strong> {{MovimientoEditar.nroRegistro}} </strong></h3>   
            </div>

            <form [formGroup]="Form"> 
                <div class="p-fluid p-formgrid p-grid">  
                    <div class="p-field p-col-12 p-sm-6 p-md-3">
                        <strong>Fecha Inicio <span>*</span>:</strong>
                        <p-calendar  
                            readonlyInput="true"
                            [showIcon]="true"
                            dateFormat="dd/mm/yy"
                            formControlName="fecha"
                        ></p-calendar> 
                    </div>
                    
                    <div [ngClass]="{'p-field p-col-12 p-sm-6 p-md-4': mostrarDropdownAlmacenDestino, 'p-field p-col-12 p-sm-6 p-md-9': !mostrarDropdownAlmacenDestino}">  
                        <strong>Almacén Origen <span>*</span>:</strong>
                        <p-dropdown [options]="arrayAlmacen" formControlName="almacenOrigen"  placeholder="Selecciona"  [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                    </div>

                    <!-- <div *ngIf="mostrarDropdownAlmacenDestino" class="">
                        <strong>Almacén Origen <span>*</span>:</strong>
                        <p-dropdown class="extender p-dropdown-sm" [options]="arrayAlmacen" formControlName="almacenOrigen"  placeholder="Selecciona"  [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                    </div> -->

                    <div *ngIf="mostrarDropdownAlmacenDestino" class="p-field p-col-12 p-sm-6 p-md-4">
                        <strong>Almacén Destino <span>*</span>:</strong>
                        <p-dropdown [options]="arrayAlmacen" formControlName="almacenDestino"  placeholder="Selecciona"  [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                    </div>

                    <div class="p-field p-col-12 p-sm-6 p-md-3">
                        <strong>Motivo <span>*</span>:</strong>
                        <p-dropdown  [options]="arrayMotivoIngreso" formControlName="motivo"  placeholder="Selecciona"  [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                    </div>
 
                    <div class="p-field p-col-12 p-sm-6 p-md-3">
                        <strong>Anexo <span>*</span></strong>  
                        <div class="p-inputgroup">  
                            <input type="text" readonly pInputText formControlName="anexo" class="p-inputtext-sm-form " placeholder="Busca un anexo">   
                            <button type="button" pTooltip="Buscar" (click)="onModalBuscarPersona()" tooltipPosition="left" pButton class="p-button-sm"  icon="pi pi-search" ></button>      
                        </div>
                    </div>

                    <div class="p-field p-col-12 p-sm-6 p-md-3">
                        <strong>Moneda <span>*</span>:</strong>
                        <p-dropdown [options]="arrayMonedas" formControlName="moneda"  placeholder="Selecciona"  [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                    </div>

                    <div class="p-field p-col-12 p-sm-6 p-md-3">
                        <strong>Tipo Cambio <span>*</span>:</strong>
                        <input type="number" pInputText formControlName="tipocambio" class="p-inputtext-sm-form" placeholder="0.00">  
                    </div> 


                    <div class="p-field p-col-12 p-sm-6 p-md-12">
                        <strong>Glosa:</strong>
                        <input type="text" pInputText formControlName="glosa" class="p-inputtext-sm-form" placeholder="ingresar una glosa">
                    </div>

                </div> 

                <div class="p-fluid p-formgrid p-grid">
                    <div class="p-field p-col-12 p-md-4"> 
                        <button 
                            pButton pRipple type="button" label="Agregar detalle"
                            class="p-button-generico-azul" icon="pi pi-plus"
                            (click)="onAgregarDetalle()">
                        </button>
                    </div>
                </div>

                <p-table   
                class="tabladetalles"
                [value]="detallesForm" 
                responsiveLayout="scroll" >  
    
                <ng-template pTemplate="header">
                    <tr>
                        <th>Acción</th>
                        <th id="lg-200">Cod.Producto</th>
                        <th>Descripción</th>
                        <th id="sd">Cantidad</th>
                        <th>Und Medida</th>
                        <th id="sd">Val.Unitario</th>
                        <th id="sd">Val.Total</th>
                        <th id="lg-120">Guia Remisión</th>
                        <th>T.Doc.Ref</th>
                        <th id="lg-120">Num.Doc.Ref</th>
                        <th id="sd">N.Serie</th>
                        <th id="sd">N.Lote</th>
                        <th>Fec.Vencimiento</th> 
                    </tr>
                </ng-template>
    
    
                <ng-template pTemplate="body" let-detalles  let-rowIndex="rowIndex" formArrayName="arrayDetalles">
                        
                    <tr   [formGroupName]="rowIndex"> 
                        <td>
                            <button  
                                class="p-button-cancelar"
                                pButton 
                                type="button" 
                                (click)="onEliminarDetalle(rowIndex, detalles.value.movimientodetalleid)"
                                icon="pi pi-trash">  
                            </button>
                        </td> 
                        <td id="lg-200">
                            <strong class="p-column-title">Cod.Producto</strong> 
                            <div class="p-inputgroup">  
                                <input type="text" class="p-inputtext-sm-form"
                                (keydown.Tab)="onBuscarProductoPorCodigo(rowIndex)"
                                (keydown.enter)="onBuscarProductoPorCodigo(rowIndex)"  
                                pInputText formControlName="codigoProducto">   
                                <button type="button" (click)="onModalBuscarProducto(rowIndex)" pTooltip="Buscar" tooltipPosition="left" 
                                    pButton icon="pi pi-search" class="p-button-generico-azul">
                                </button>      
                            </div>                            
                        </td>
                        <td>
                            <strong class="p-column-title">Descripción</strong>
                            <input type="text" pInputText class="p-inputtext-sm-form"  formControlName="descripcion">  
                        </td>
                        <td id="sd">
                            <strong class="p-column-title">Cantidad</strong>
                            <input type="number"  style="text-align: right;" (blur)="onCalcularValorTotal(rowIndex, detalles.value)" (onChange)="onCalcularValorTotal(rowIndex, detalles.value)"  class="p-inputtext-sm-form" pInputText formControlName="cantidad">  
                        </td>
                        <td id="lg">
                            <strong class="p-column-title">Und Medida</strong>
                            <p-dropdown  [options]="arrayUnidadesMedida"  appendTo="body"
                             formControlName="unidadMedida"  placeholder="Seleccionar"  
                             [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                        </td>
                        <td id="sd">
                            <strong class="p-column-title">Val.Unitario</strong>
                            <input type="number"  style="text-align: right;" (blur)="onCalcularValorTotal(rowIndex, detalles.value)" (onchange)="onCalcularValorTotal(rowIndex, detalles.value)"  class="p-inputtext-sm-form" [min]="0" pInputText formControlName="valorUnitario">  
                        </td>
                        <td id="sd">
                            <strong class="p-column-title">Val.Total</strong>
                            <input type="number"  readonly style="text-align: right;" class="p-inputtext-sm-form" pInputText formControlName="valorTotal">  
                        </td>
                        <td id="lg-120">
                            <strong class="p-column-title">Guia Remisión</strong>
                            <input type="text"   style="width: 120px;"  class="p-inputtext-sm-form" pInputText formControlName="nroGuiaRemision">  
                        </td>
                        <td id="lg">
                            <strong class="p-column-title">T.Doc.Ref</strong>
                            <p-dropdown appendTo="body"  [options]="arrayDocumentos"
                             formControlName="tipodocumentoRef"  placeholder="Seleccionar"   
                             [showClear]="true"  optionLabel="valor1"></p-dropdown>     
                        </td>
                        <td id="lg-120">
                            <strong class="p-column-title">Num.Doc.Ref</strong>
                            <input type="number" [min]="0"  class="p-inputtext-sm-form" pInputText formControlName="nrodocumentoref">  
                        </td>
                        <td id="sd">
                            <strong class="p-column-title">N.Serie</strong>
                            <input type="number" [min]="0"  class="p-inputtext-sm-form" pInputText formControlName="nroSerie">  
                        </td>
                        <td id="sd">
                            <strong class="p-column-title">N.Lote</strong>
                            <input type="number"[min]="0"   class="p-inputtext-sm-form" pInputText formControlName="nroLote">  
                        </td>
                        <td>
                            <strong class="p-column-title">F.Vencimiento</strong>
                            <p-calendar      
                                readonlyInput="true"
                                appendTo="body"  
                                [showIcon]="true" 
                                dateFormat="dd/mm/yy"
                                formControlName="fecVencimiento" 
                            ></p-calendar> 
                        </td>
     
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <span> No existen registros </span>
                    </tr>
                </ng-template>
                 
                </p-table>  
            </form>   
        </div> 
    </div>   
</div>
  
<!-- VISTAS Y MODALES -->
<div *ngIf="modalBuscarPersona">
    <p-dialog header="BUSCAR PROVEEDOR" [(visible)]="modalBuscarPersona" [modal]="true" [style]="{width: '70vw'}">
        <app-buscar-persona  [dataPersona]="'Proveedor'" (PersonaSelect)="onPintarPersonaSeleccionada($event)"> </app-buscar-persona>
    </p-dialog> 
</div>  
 
<div *ngIf="modalBuscarProducto">
    <p-dialog header="BUSCAR PRODUCTO" [(visible)]="modalBuscarProducto" [modal]="true" [style]="{width: '80vw'}">
        <app-buscar-producto [dataProductos]="dataProductos"  (productoSelect)="onPintarProductoSeleccionado($event)"> </app-buscar-producto>
    </p-dialog> 
</div>  

<app-movimiento-reporte *ngIf="VistaReporte" [dataReporte]="dataReporte" (cerrar)="onRetornar()"  ></app-movimiento-reporte> 
